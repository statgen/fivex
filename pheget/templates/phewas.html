<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/locuszoom@0.10.0-beta.1/dist/locuszoom.css"
        type="text/css"/>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" 
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/tabulator-tables@4.4.3/dist/css/bootstrap/tabulator_bootstrap4.min.css">
  <title>PheGET - Single Variant View</title>
</head>

<style>
  .padtop {
    padding-top: 20px;
  }

  .text-with-definition {
    text-decoration: dotted underline;
  }
</style>

<body>

<div class="container-fluid">
  <div class="row padtop">
    <div class="col-sm-10">
      <div id="home-searchbox">
        <form id="variant-search">
          <div class="input-group">
            <input id="query-field" name="query-field" autocomplete="off" class="form-control"
                   type="text"
                   placeholder="Search for a variant, e.g. chr19:488506 or rs10424907" autofocus/>

            <div class="input-group-append">
              <button id="navigate-variant" class="btn btn-primary" type="submit">Search</button>
            </div>
          </div>
        </form>
      </div>
    </div>
</div>

<p>
<center>
    <a href="/" class="btn btn-primary btn-sm" role="button" aria-pressed="true"><span class="fa fa-home"></span> Back to PheGET Homepage</a> 
</center>
<h1>Variant: chr{{ chrom }}:{{ "{:,}".format(pos) }} {{ ref }}/{{ alt }} for all tissues and genes</h1>
</p>

<style>
dl.inline-flex {
  display: flex;
  flex-flow: row;
  flex-wrap: wrap;
  width: 360px;
  overflow: visible;
}
dl.inline-flex dt {
  flex: 0 0 50%;
  text-overflow: ellipsis;
  overflow: hidden;
}
dl.line-flex dd { 
  margin-left: auto;
  text-align: left;
  text-overflow: ellipsis;
  overflow: hidden;
  flex: 0 0 50%
}
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col">
      <button class="btn btn-info" type="button" data-toggle="collapse" data-target="#variantInformation" aria-expanded="true" aria-controls="variantInformation">
        Variant Information from Sequence Genotype
      </button>
      <div class="collapse show" id="variantInformation">
        <div class="card-group">
          <div class="card">
            <div class="card-body">
              <dl class="inline-flex">
                <dt>Allele count/total</dt>
                  <dd>{{ ac }} / {{ an }}</dd>
                <dt>Allele frequency</dt>
                  <dd>{{ af }}</dd>
                </dl>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <dl class="inline-flex">
                <dt>Top gene</dt>
                  <dd>{{ top_gene }}</dd>
                <dt>Top tissue</dt>
                  <dd>{{ top_tissue }}</dd>
              </dl>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <dt>
                  {{ "Overlapping" if is_inside_gene else "Nearest" }} gene(s):
              </dt>
                <dd>
                  {% for gene in nearest_genes %}
                    <span class="text-with-definition" title="{{ gene.ensg }}">{{ gene.symbol }}</span>
                    {%- if not loop.last -%},{% endif %}
                  {% else %}
                    (no genes found)
                  {% endfor %}
                </dd>
              </dl>
            </div>
          </div>
        </div>
        <div class="card-group row">
          <div class="col-9">
            <div class="card">
              <div class="card-body">
                <button class="btn btn-sm btn-secondary" disabled data-toggle="tooltip" data-placement="top" title="External links for more information about this variant"><span class="fa fa-info-circle"></span>  Variant information </button>
                <a href="https://www.ncbi.nlm.nih.gov/snp/?term={{ chrom }}%5BChromosome%5D+AND+({{ pos }}%5BBase+Position%5D+)" class="btn btn-primary btn-sm" role="button" aria-pressed="true"><span class="fa fa-external-link"></span> dbSNP</a>
                <a href="https://bravo.sph.umich.edu/freeze5/hg38/variant/{{ chrom }}-{{ pos }}-{{ ref }}-{{ alt }}" class="btn btn-primary btn-sm" role="button" aria-pressed="true"><span class="fa fa-external-link"></span> BRAVO</a>
                <a href="https://gtexportal.org/home/snp/chr{{ chrom }}_{{ pos }}_{{ ref }}_{{ alt }}_b38" class="btn btn-primary btn-sm" role="button" aria-pressed="true"><span class="fa fa-external-link"></span> GTEx Portal</a>
                <a href="http://genome.ucsc.edu/cgi-bin/hgTracks?db=hg38virtModeType=default&virtMode=0&nonVirtPosition=&position=chr{{ chrom }}}}%3A{{ pos }}-{{ pos }}" class="btn btn-primary btn-sm" role="button" aria-pressed="true"><span class="fa fa-external-link"></span> UCSC</a>
<!--                <a href="http://pheweb.sph.umich.edu/variant/{{ rs_num }}" class="btn btn-primary btn-sm" role="button" aria-pressed="true"><span class="fa fa-external-link"></span> PheWeb</a> -->
                <a href="https://gnomad.broadinstitute.org/variant/{{ chrom }}-{{ pos }}-{{ ref }}-{{ alt }}?dataset=gnomad_r2_1" class="btn btn-primary btn-sm" role="button" aria-pressed="true"><span class="fa fa-external-link"></span> gnomAD</a>
              </div>
            </div>
          </div>
          <div class="col-3">
            <div class="card">
              <div class="card-body">
                <a href="https://www.gtexportal.org/home/documentationPage" class="btn btn-info btn-sm"><span class="fa fa-external-link"></span> Definition of NES</a> 
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<br>
<div class="container-fluid">
  <div class="row justify-content-start">
    <div class="col-sm">
      <form action="#" method="post" class="grouping" id="grouping-buttons">
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
          <button type="button" class="btn btn-secondary" disabled  data-toggle="tooltip" data-placement="top" title="Reorder the x-axis by one of these listed categories"> Group by: </button>        
          <label class="btn btn-primary" data-toggle="tooltip" data-placement="top" title="Group eQTLs by tissues, sorted alphabetically">
              <input type="radio" name="group-options" autocomplete=off id="group-tissue" value="tissue"> Tissue
          </label>
          <label class="btn btn-primary"  data-toggle="tooltip" data-placement="top" title="Group eQTLs by systems as defined by the GTEx project, sorted alphabetically">
              <input type="radio" name="group-options" autocomplete=off id="group-system" value="system"> System
          </label>
          <label class="btn btn-primary active" data-toggle="tooltip" data-placement="top" title="Group eQTLs by gene, sorted by the position of the genes' translation start sites">
              <input type="radio" name="group-options" autocomplete=off id="group-symbol" value="symbol"> Gene
          </label>
        </div>
      </form>
    </div>

    <div class="col-sm">
      <form action="#" method="post" class="yaxis-display" id="transform-y">
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
          <button type="button" class="btn btn-secondary" data-toggle="tooltip" data-placement="top" title="Switches the variable plotted on the y-axis between -log10 P-value and Normalized Effect Size (NES)." disabled> Show: </button>        
          <label class="btn btn-success active" data-toggle="tooltip" data-placement="top" title="Display -log10 P-values on the Y-axis">
            <input type="radio" name="y-options" autocomplete=off id="show-log-pvalue" value="log_pvalue"> P-values
          </label>
          <label class="btn btn-success" data-toggle="tooltip" data-placement="top" title="Displays Normalized Effect Size (NES) on the Y-axis. See 'Definition of NES' for an explanation of NES.">
            <input type="radio" name="y-options" autocomplete=off id="show-beta" value="beta"> Effect Size (NES)
          </label>
        </div>
      </form>
    </div>

    <div class="col-sm">
      <form action="#" method="post" class="label-display" id="toggle-labels">
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
          <button type="button" class="btn btn-secondary" data-toggle="tooltip" data-placement="top" title="Toggles labels for the most significant eQTLs. Significance is determined by P-values." disabled> Label: </button>
          <label class="btn btn-info" data-toggle="tooltip" data-placement="top" title="Disable all labels">
            <input type="radio" name="label-options" autocomplete=off id="label-none" value="0"> None
          </label>
          <label class="btn btn-info active" data-toggle="tooltip" data-placement="top" title="Label the 5 eQTLs with most significant P-values">
            <input type="radio" name="label-options" autocomplete=off id="label-5" value="5"> Top 5
          </label>
          <label class="btn btn-info"  data-toggle="tooltip" data-placement="top" title="Label the 50 eQTLs with most significant P-values">
            <input type="radio" name="label-options" autocomplete=off id="label-50" value="50"> Top 50
          </label>
        </div>
      </form>
    </div>

  </div>
</div>


<div id="plot"></div>
<div id="table" style="width:90%;margin:0 auto"></div>

{# These files must be included to make a LocusZoom plot #}
<script src="https://cdn.jsdelivr.net/npm/locuszoom@0.10.0-beta.1/dist/locuszoom.vendor.min.js"
        type="application/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/locuszoom@0.10.0-beta.1/dist/locuszoom.app.min.js"
        type="application/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@4.4.3/dist/js/tabulator.min.js"
        type="text/javascript"></script>

<!-- Allows text warping in Tabulator title text. Reference: https://github.com/olifolkerd/tabulator/issues/988 -->
<style>
  .tabulator .tabulator-header .tabulator-col .tabulator-col-content .tabulator-col-title{
	white-space: normal;
	text-overflow: clip;
}
</style>

<script src="{{ url_for('static', filename='js/phewas_scatter.js') }}" type="application/javascript"></script>
<script src="{{ url_for('static', filename='js/searchbox.js') }}" type="application/javascript"></script>
<script type="application/javascript">
    const table = makeTable('#table');
    const [plot, datasources] = makePhewasPlot({{chrom|tojson}}, {{pos|tojson}}, '#plot');
    plot.subscribeToData(['phewas:log_pvalue', 'phewas:gene_id', 'phewas:tissue', 'phewas:system', 'phewas:symbol', 'phewas:beta', 'phewas:stderr_beta'], updateTable.bind(null, table));

    // Use omnisearch (https://portaldev.sph.umich.edu/api_internal_dev/v1/annotation/omnisearch) to parse rsids
    document.getElementById('variant-search').addEventListener('submit', function () {
        event.preventDefault();
        const variant = document.getElementById('query-field').value;
        if (!variant) {
            return;
        }
        parseSearch(variant);
    });
    var groupVar = document.forms['grouping-buttons'].elements['group-options'];
    for (var i=0, len=groupVar.length; i<len; i++) {
      groupVar[i].onchange = function() {
        groupByThing(plot, this.value);
      }
    }

    var yaxisVar = document.forms['transform-y'].elements['y-options'];
    for (var j=0, len=yaxisVar.length; j<len; j++) {
      yaxisVar[j].onchange = function() {
        switchY(plot, table, this.value);
      }
    }

    var labelVar = document.forms['toggle-labels'].elements['label-options'];
    for (var k=0, len=labelVar.length; k<len; k++) {
      labelVar[k].onchange = function() {
        labelTopVariants(plot, this.value);
      }
    }

</script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>
