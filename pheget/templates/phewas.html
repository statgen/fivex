<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/locuszoom@0.10.0-beta.1/dist/locuszoom.css"
          type="text/css"/>

<!-- Using these will allow us to properly display toggled buttons (show button being held down after a click)
  but requires a rewrite of how to call the functions called by pressing buttons (using jquery). 
  Will fix this later.
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script> 
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>   -->

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" 
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/tabulator-tables@4.4.3/dist/css/bootstrap/tabulator_bootstrap4.min.css">
    <title>PheGET - Single Variant View</title>
</head>

<style>
    .padtop {
        padding-top: 20px;
    }
</style>

<body>

<!-- Add variant information box with external links here
  Example links to external sources:
https://bravo.sph.umich.edu/freeze5/hg38/variant/19-488506-A-G
https://gtexportal.org/home/snp/chr19_488506_A_G_b38
https://www.ncbi.nlm.nih.gov/snp/rs10424907
I am building a backend tabixable file that will take in chrom and pos, 
and return ref, alt, AC, AF, AN, top gene, top tissue, and rsid;
If given a range, it will return the most top gene and top tissue for the full range only
-->

<div class="padtop">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-10">
                <div id="home-searchbox">
                    <form id="variant-search">
                        <div class="input-group">
                            <input id="query-field" name="query-field" autocomplete="off" class="form-control"
                                   type="text"
                                   placeholder="Search for a variant, e.g. chr19:488506 or rs10424907" autofocus/>

                            <div class="input-group-append">
                                <button id="navigate-variant" class="btn btn-primary" type="submit">Search</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<p>
<center>
    <a href="/">Back to PheGET Homepage</a>
</center>
<h1>Variant: chr{{ chrom }}:{{ "{:,}".format(pos) }} {{ ref }}/{{ alt }} for all tissues and genes</h1>
</p>


<!--  Allele count: {{ ac }} <br>
  Allele frequency: {{ af }} <br>
  Total number of alleles: {{ an }} <br>
  Top gene: {{ top_gene }} <br>
  Top tissue: {{ top_tissue }} <br>
-->

<!--
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-4 col-md-6 col-sm-12">
      <div class="panel panel-default" id="variant-summary">
        <div class="panel-heading">Summary</div>
          <div class="panel-body">
            <dl class="dl-horizontal" style="margin-bottom: 0px;">
-->
<style>
dl.inline-flex {
  display: flex;
  flex-flow: row;
  flex-wrap: wrap;
  width: 360px;
  overflow: visible;
}
dl.inline-flex dt {
  flex: 0 0 50%;
  text-overflow: ellipsis;
  overflow: hidden;
}
dl.line-flex dd { 
  margin-left: auto;
  text-align: left;
  text-overflow: ellipsis;
  overflow: hidden;
  flex: 0 0 50%
}
</style>

<div class="card" style="width: 30rem;">
  <div class="card-body">
            <dl class="inline-flex">
              <dt>Variant</dt>
                <dd>chr{{ chrom }}:{{ pos }} {{ ref }}/{{ alt }}</dd>
              <dt>Allele count</dt>
                <dd>{{ ac }}</dd>
              <dt>Allele frequency</dt>
                <dd>{{ af }}</dd>
              <dt>Total # of alleles</dt>
                <dd>{{ an }}</dd>
              <dt>Top gene</dt>
                <dd>{{ top_gene }}</dd>
              <dt>Top tissue</dt>
                <dd>{{ top_tissue }}</dd>
              <dt>dbSNP</dt>
                <dd>
                  <a href="https://www.ncbi.nlm.nih.gov/snp/?term={{ chrom }}%5BChromosome%5D+AND+({{ pos }}%5BBase+Position%5D+)">link</a>
                </dd>
              <dt>BRAVO</dt>
                <dd>
                  <a href="https://bravo.sph.umich.edu/freeze5/hg38/variant/{{ chrom }}-{{ pos }}-{{ ref }}-{{ alt }}">link</a>
                </dd>
              <dt>GTEx Portal</dt>
                <dd>
                  <a href="https://gtexportal.org/home/snp/chr{{ chrom }}_{{ pos }}_{{ ref }}_{{ alt }}_b38">link</a>
                </dd>
              <dt>UCSC</dt>
                <dd>
                  <a href="http://genome.ucsc.edu/cgi-bin/hgTracks?db=hg38virtModeType=default&virtMode=0&nonVirtPosition=&position=chr{{ chrom }}}}%3A{{ pos }}-{{ pos }}">link</a>
                </dd>
          </dl>
              <!--
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  -->
  Note: <b>Normalized Effect Size (NES)</b> is the effect of one additional alternate allele on the inverse normalized expression level of a gene, after adjusting for covariates. More details about analysis methods can be found at the <a href="https://www.gtexportal.org/home/documentationPage"><b>GTEx Portal website</a></b>.
</div>
</div>


<div class="container-fluid">
   <form action="#" method="post" class="grouping" id="grouping-buttons">
    <div class="btn-group btn-group-toggle" data-toggle="buttons">
        <label class="btn btn-secondary disabled">
            <input type="radio"> Group by:
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="group-options" autocomplete=off id="group-tissue" value="tissue"> Tissue
        </label>
        <label class="btn btn-primary focus active">
            <input type="radio" name="group-options" autocomplete=off id="group-system" value="system"> System
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="group-options" autocomplete=off id="group-symbol" value="symbol"> Gene
        </label>
    </div>
  </form>
</div>

<div class="container-fluid">
  <form action="#" method="post" class="yaxis-display" id="transform-y">
    <div class="btn-group btn-group-toggle" data-toggle="buttons">
        <label class="btn btn-secondary disabled">
          <input type="radio"> Show:
        </label>
        <label class="btn btn-success focus active">
            <input type="radio" name="y-options" autocomplete=off id="show-log-pvalue" value="log_pvalue"> P-values
        </label>
        <label class="btn btn-success">
            <input type="radio" name="y-options" autocomplete=off id="show-beta" value="beta"> NES
        </label>
   </div>
  </form>
</div>

<div class="container-fluid">
    <div class="btn-group" data-toggle="buttons">
        <button type="button" class="btn btn-secondary" disabled>Label:</button>
        <button id="label-toggle" type="button" class="btn btn-info">Top 5</button><br>

    </div>
</div>


<div id="plot"></div>
<div id="table" style="width:90%;margin:0 auto"></div>

{# These files must be included to make a LocusZoom plot #}
<script src="https://cdn.jsdelivr.net/npm/locuszoom@0.10.0-beta.1/dist/locuszoom.vendor.min.js"
        type="application/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/locuszoom@0.10.0-beta.1/dist/locuszoom.app.min.js"
        type="application/javascript"></script>

<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@4.4.3/dist/js/tabulator.min.js"
        type="text/javascript"></script>

<script src="{{ url_for('static', filename='js/phewas_scatter.js') }}" type="application/javascript"></script>
<script src="{{ url_for('static', filename='js/searchbox.js') }}" type="application/javascript"></script>
<script type="application/javascript">
    const table = makeTable('#table');
    const [plot, datasources] = makePhewasPlot({{chrom|tojson}}, {{pos|tojson}}, '#plot');
    plot.subscribeToData(['phewas:log_pvalue', 'phewas:gene_id', 'phewas:tissue', 'phewas:system', 'phewas:symbol', 'phewas:beta', 'phewas:stderr_beta'], updateTable.bind(null, table));

    // Use omnisearch (https://portaldev.sph.umich.edu/api_internal_dev/v1/annotation/omnisearch) to parse rsids
    document.getElementById('variant-search').addEventListener('submit', function () {
        event.preventDefault();
        const variant = document.getElementById('query-field').value;
        if (!variant) {
            return;
        }
        parseSearch(variant);
    });

    /* These don't work when we are using Bootstrap
    document.getElementById('group-tissue').addEventListener('click', function() {
      groupByThing(plot, 'tissue');
    });
    document.getElementById('group-system').addEventListener('click', function() {
        groupByThing(plot, 'system');
    });
    document.getElementById('group-symbol').addEventListener('click', function() {
      groupByThing(plot, 'symbol');
    });
    */
    
    /* This works when we are using bootstrap  */
    var groupVar = document.forms['grouping-buttons'].elements['group-options'];
    for (var i=0, len=groupVar.length; i<len; i++) {
      groupVar[i].onchange = function() {
        groupByThing(plot, this.value);
      }
    }

    var yaxisVar = document.forms['transform-y'].elements['y-options'];
    for (var j=0, len=yaxisVar.length; j<len; j++) {
      yaxisVar[j].onchange = function() {
        switchY(plot, table, this.value);
      }
    }
    
    document.getElementById('label-toggle').addEventListener('click', function() {
        labelToggle(plot);
        if (this.innerText ==='Top 5') {
          this.innerText = 'Off';
        } else if (this.innerText === 'Off') {
          this.innerText = 'Top 50';
        } else {
          this.innerText = 'Top 5';
        }
    });
</script>


<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


</body>
</html>
