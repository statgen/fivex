<VirtualHost *:80>
	# Define how to handle INSECURE connections: redirect to the same url under https
	ServerName website.org
	ServerAdmin abought@umich.edu

	RewriteEngine on
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]

	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>


<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerName website.org

        # strip the X-Forwarded-Proto header from incoming requests
        RequestHeader unset X-Forwarded-Proto

        # set the header for requests using HTTPS
        RequestHeader set X-Forwarded-Proto https env=HTTPS

        # Forward requests for the app to gunicorn
        # (and don't proxy requests related to certbot)
        ProxyPass /.well-known !
        ProxyPass http://localhost:8877/ keepalive=On
        ProxyPassReverse http://localhost:8877/

        # UM CSG recommended SSL settings as of March 2018; may be superseded by LetsEncrypt recommended defaults
        SSLEngine on
        SSLProtocol All -SSLv2 -SSLv3
        SSLHonorCipherOrder On
        SSLCipherSuite ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5

        ## HSTS: guarantee HTTPS and remember for 1 Year on all secure connections
        ##   Because this is cached by the browser, we recommend only enabling this line once you're happy with your
        ##    server deployment
        #Header always set Strict-Transport-Security max-age=31536000;

        # Logging configuration
        LogLevel warn
    </VirtualHost>
</IfModule>
